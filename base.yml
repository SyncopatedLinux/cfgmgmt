---

- hosts: all
  become: True
  gather_subset:
    - hardware
    - network
  vars:
    path:
      - "{{ lookup('env','HOME') }}/.local/bin"
      - "{{ lookup('env','HOME') }}/.cargo/bin"

  environment:
    PATH: "{{ ansible_env.PATH }}:/sbin:/bin:{{ path|join(':') }}"
    PKG_CONFIG_PATH: "/usr/share/pkgconfig:/usr/lib/pkgconfig:/usr/local/lib/pkgconfig"
    ZSH: "/usr/local/share/oh-my-zsh"
    DISPLAY: ":0"

  pre_tasks:

    - name: Include distro vars
      ansible.builtin.include_vars:
        file: vars/{{ ansible_distribution }}.yml
      tags: ['base']

    - name: Symlink /etc/os-release to /etc/system-release
      ansible.builtin.file:
        src: /etc/os-release
        dest: /etc/system-release
        state: link
      tags: ['base']

    - name: Get the distrib_id
      ansible.builtin.shell: |
        cat /etc/lsb-release | grep DISTRIB_ID | awk -F '=' '{print $2}'
      register: distrib_id
      tags: ['facts', 'base', 'system', 'user']

    - name: Set distrib_id as a fact
      ansible.builtin.set_fact:
        distrib_id: "{{ distrib_id.stdout }}"
      tags: ['facts', 'base', 'system', 'user']

    - name: Set ansible_home
      ansible.builtin.set_fact:
        ansible_home: "{{ lookup('env','HOME') }}/Workspace/ohmannium"
      tags: ['base']

    - name: Set admin_group variable
      ansible.builtin.set_fact:
        admin_group: "{{ admin_group }}"
      tags: ['base']

    - block:
        - name: Print keyserver hostname
          ansible.builtin.debug:
            msg: "{{ keyserver }}"
          when: ( debugging is defined or keyserver is defined )

        - name: Check if keys are present
          ansible.builtin.stat:
            path: "{{ user.home }}/.ssh/id_rsa"
          register: keys

        - name: Copy keys from remote host
          become: False
          delegate_to: 127.0.0.1
          run_once: True
          ansible.builtin.shell: "scp {{ user.name }}@{{ keyserver }}:~/.ssh/{{ item }} {{ user.home }}/.ssh/{{ item }}"
          args:
            chdir: "{{ user.home }}"
          with_items:
            - id_rsa
            - id_rsa.pub
          when:
            - not keys.stat.exists
            - keyserver is defined
          tags: ['keys']

        - name: Enable ssh daemon
          ansible.builtin.service:
            name: sshd
            enabled: True

      ignore_errors: "{{ ansible_check_mode }}"
      tags: ['ssh']

    #TODO: add task to install rubygems, ruby-devel, git
    - block:
        - name: Set --no-user-install in gemrc
          ansible.builtin.copy:
            content: |
              gem: --no-user-install --no-document

            dest: "/etc/gemrc"
            owner: root

        - name: Gather list of installed gems
          ansible.builtin.shell: "gem list | awk '{ print $1 }'"
          register: gemlist
          changed_when: gemlist.rc != 0
          ignore_errors: "{{ ansible_check_mode }}"

        - name: Set list of gems to install
          ansible.builtin.set_fact:
            _gems: "{{ gems|difference(gemlist.stdout) }}"

        - name: Install ruby gems
          ansible.builtin.shell: "gem install {{ item }}"
          with_items:
            - "{{ _gems }}"
          when: _gems | length > 0

      vars:
        gems:
          - activesupport
          - awesome_print
          - bcrypt_pbkdf
          - childprocess
          - clipboard
          - colorize
          - coltrane
          - ed25519
          - eventmachine
          - ffi
          - fractional
          - geo_coord
          - highline
          - i3ipc
          - i18n
          - kramdown
          - logging
          - minitest
          - mocha
          - multi_json
          - neovim
          - net-ssh
          - parallel
          - pastel
          - pry
          - pry-doc
          - rake
          - rdoc
          - rexml
          - rouge
          - ruby-openai
          - ruport
          - sync
          - sys-proctable
          - treetop
          - tty-box
          - tty-command
          - tty-prompt
          - tty-screen
          - yaml


  roles:

    - role: user
      tags: ['user']

    - role: distro
      tags: ['distro']

    - role: base
      tags: ['base']

    - role: network
      tags: ['netork']

    - role: audio
      tags: ['audio']

    - role: system
      tags: ['system']

    - role: applications
      tags: ['applications']

  post_tasks:

      - name: Cleanup old backup files
        ansible.builtin.script: /usr/local/bin/cleanup.sh
        when: cleanup is defined
        tags: ['cleanup']

      # Reset is not implemented local connection
      - name: Reboot host
        ansible.builtin.reboot:
        async: 1
        poll: 0
        ignore_errors: True
        when: reboot is defined

      - name: Wait for host to reboot
        ansible.builtin.wait_for_connection:
          connect_timeout: 20
          sleep: 5
          delay: 5
          timeout: 120
        when: reboot is defined
