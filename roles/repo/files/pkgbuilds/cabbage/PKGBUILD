# This is an example PKGBUILD file. Use this as a start to creating your own,
# and remove these comments. For more information, see 'man PKGBUILD'.
# NOTE: Please fill out the license field for your package! If it is unknown,
# then please put 'unknown'.

_name=cabbage
pkgname=cabbage-git
pkgver=2.9.0
pkgrel=1
epoch=
pkgdesc="Framework for developing audio plugins with the Csound programming language."
arch=()
url=""
license=('GPLv3+')
groups=('pro-audio')
depends=('gcc-libs' 'glibc' 'csound' 'csound-doc')
makedepends=('cmake' 'unzip' 'git' 'vst3sdk' 'vst2sdk' 'csound' 'freetype2' 'libpng' 'harfbuzz' 'glib2' 'alsa-lib' 'webkit2gtk' 'gtk3'  'curl' 'libsndfile' 'desktop-file-utils')
checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=
changelog=
source=("git+https://github.com/rorywalsh/cabbage.git")
noextract=()
md5sums=()
validpgpkeys=()

prepare() {
  cd "{_name}"
  git checkout v${pkgver}
  git submodule init
  git submodule update

  sed -i -e "s/;Multimedia//g" Installers/Linux/Cabbage.desktop

  declare -A PROJECTS=(
    Cabbage
    CabbagePluginEffect
    CabbagePluginSynth
    CabbagePluginMidiEffect
  )

}

build() {
  cd "{_name}"

  export CXXFLAGS="-fPIC $CXXFLAGS"
  export CFLAGS="-fPIC $CFLAGS"

  for project in ${PROJECTS}; do
    cmake -DCMAKE_INSTALL_PREFIX=/usr \
          -W no-dev \
          -B build \
          -S .

    make VERBOSE=1 -C build
  done

	./configure --prefix=/usr
	make
}

check() {
	cd "$pkgname-$pkgver"
	make -k check
}

package() {

  cp build_Cabbage/Cabbage_artefacts/Debug/Cabbage %{buildroot}/%{_bindir}/

  cp build_CabbagePluginEffect/CabbagePluginEffect_artefacts/Debug/Standalone/* %{buildroot}/%{_bindir}/
  cp build_CabbagePluginEffect/CabbagePluginEffect_artefacts/Debug/VST/* %{buildroot}/%{_libdir}/vst/
  cp -rav build_CabbagePluginEffect/CabbagePluginEffect_artefacts/Debug/VST3/* %{buildroot}/%{_libdir}/vst3/

  cp build_CabbagePluginEffect/CabbagePluginEffect_artefacts/Debug/Standalone/* %{buildroot}/%{_bindir}/
  cp build_CabbagePluginEffect/CabbagePluginEffect_artefacts/Debug/VST/* %{buildroot}/%{_libdir}/vst/
  cp -rav build_CabbagePluginEffect/CabbagePluginEffect_artefacts/Debug/VST3/* %{buildroot}/%{_libdir}/vst3/

  cp build_CabbagePluginMidiEffect/CabbagePluginMidiEffect_artefacts/Debug/Standalone/* %{buildroot}/%{_bindir}/
  cp build_CabbagePluginMidiEffect/CabbagePluginMidiEffect_artefacts/Debug/VST/* %{buildroot}/%{_libdir}/vst/
  cp -rav build_CabbagePluginMidiEffect/CabbagePluginMidiEffect_artefacts/Debug/VST3/* %{buildroot}/%{_libdir}/vst3/

}
